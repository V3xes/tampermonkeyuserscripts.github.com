<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />
  <title>Userscripts</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0b1220;
      --panel-2:#0a1426;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#7c3aed;
      --accent-2:#06b6d4;
      --code:#0c162b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:
        radial-gradient(1200px 800px at 10% -10%, #14213d40 0%, transparent 60%),
        radial-gradient(1000px 700px at 90% -20%, #1f293740 0%, transparent 65%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      line-height:1.45;
    }
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    /* Letter groups */
    .group{margin:10px 0 18px}
    .group h2{
      margin:10px 2px; font-size:12px; letter-spacing:.12em; color:#b5c2de; opacity:.75;
    }
    /* Rounded bars */
    details.item{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: linear-gradient(180deg, #0b1220, #0a1427);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin:10px 0;
    }
    details[open].item{ background: linear-gradient(180deg, #0b1220, #0b1020) }
    summary{
      list-style:none;
      padding:14px 16px;
      display:flex; gap:12px; align-items:center; cursor:pointer;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none }
    .bullet{
      width:8px;height:8px;border-radius:999px;background:linear-gradient(135deg, var(--accent-2), var(--accent));
      box-shadow: 0 0 0 2px #0b1220, 0 0 12px rgba(124,58,237,.35);
      flex:0 0 auto;
    }
    .meta{min-width:0;flex:1}
    .name{font-weight:800; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .desc{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .chev{opacity:.6; transition: transform .2s ease; font-size:14px}
    details[open] .chev{ transform: rotate(90deg); opacity:.9 }

    .panel{ border-top:1px solid var(--border); background: linear-gradient(180deg, #0a1327, #0a1222) }
    .code-wrap{
      position:relative; padding:12px;
      background:var(--code);
      border-top:1px solid #14213d; border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius);
      overflow:auto;
    }
    pre{margin:0; overflow:auto}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; color:#dbe2f6}
    .copy-btn{
      position:absolute; top:10px; right:10px;
      background:#0b1220; border:1px solid var(--border); color:#cfe2ff;
      border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer;
    }
    .copy-btn:hover{ border-color:#2a3d5d; background:#0f1a32 }
    .copied{ background:#0b1220; color:#9ee6c1; border-color:#1f6d55 }

    .loading, .error, .empty{
      border:1px dashed var(--border); border-radius:var(--radius);
      color:var(--muted); padding:18px; text-align:center; margin:10px 2px 0;
      background:#0c1528;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="status" class="loading">Loading…</div>
    <div id="container" style="display:none"></div>
  </div>

  <script>
    // Read template files from this manifest
    const MANIFEST_URL = "templates/manifest.json";
    const $ = sel => document.querySelector(sel);
    const container = $("#container");
    const status = $("#status");

    async function fetchText(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(res.status + " " + res.statusText);
      return await res.text();
    }

    function slugify(s){
      return (s || "").toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g,"") || "script";
    }

    function groupByLetter(items){
      const groups = {};
      for(const it of items){
        const ch = (it.name?.[0] || "#").toUpperCase();
        const letter = /[A-Z]/.test(ch) ? ch : "#";
        (groups[letter] ||= []).push(it);
      }
      const order = Object.keys(groups).sort((a,b)=>{
        if(a==="#" && b!=="#") return 1;
        if(b==="#" && a!=="#") return -1;
        return a.localeCompare(b);
      });
      return { groups, order };
    }

    // Optional: parse // ==UserScript== block if present (fallback)
    function parseUserscriptMeta(code){
      const meta = {};
      const block = code.match(/\/\/\s*==UserScript==[\s\S]*?\/\/\s*==\/UserScript==/i);
      if(block){
        block[0].split(/\r?\n/).forEach(line=>{
          const m = line.match(/^\s*\/\/\s*@(\w+)\s+(.*)$/);
          if(m){ meta[m[1].toLowerCase()] = m[2].trim(); }
        });
      }
      return meta;
    }

    function applyPlaceholders(text, ctx){
      return text.replace(/\{\{\s*([\w-]+)\s*\}\}/g, (m, k)=>{
        return (k in ctx) ? String(ctx[k]) : m;
      });
    }

    function makeItem(s){
      const det = document.createElement("details");
      det.className = "item";
      det.id = "s-" + s.slug;

      const summary = document.createElement("summary");
      const bullet = document.createElement("div"); bullet.className = "bullet";
      const meta = document.createElement("div"); meta.className = "meta";
      const name = document.createElement("div"); name.className = "name"; name.textContent = s.name || s.filename;
      const desc = document.createElement("div"); desc.className = "desc"; desc.textContent = s.description || "";
      meta.appendChild(name); meta.appendChild(desc);
      const chev = document.createElement("div"); chev.className = "chev"; chev.textContent = "›";
      summary.appendChild(bullet); summary.appendChild(meta); summary.appendChild(chev);

      const panel = document.createElement("div"); panel.className = "panel";
      const codeWrap = document.createElement("div"); codeWrap.className = "code-wrap";
      const copyBtn = document.createElement("button"); copyBtn.type="button"; copyBtn.className="copy-btn"; copyBtn.textContent="Copy";
      copyBtn.addEventListener("click", async (e)=>{
        e.stopPropagation();
        try{
          await navigator.clipboard.writeText(s.code);
          copyBtn.textContent = "Copied!";
          copyBtn.classList.add("copied");
          setTimeout(()=>{ copyBtn.textContent="Copy"; copyBtn.classList.remove("copied"); }, 1200);
        }catch{
          copyBtn.textContent = "Failed";
          setTimeout(()=>{ copyBtn.textContent="Copy"; }, 1200);
        }
      });
      const pre = document.createElement("pre");
      const code = document.createElement("code"); code.textContent = s.code;
      pre.appendChild(code);
      codeWrap.appendChild(copyBtn); codeWrap.appendChild(pre);
      panel.appendChild(codeWrap);

      det.appendChild(summary); det.appendChild(panel);
      return det;
    }

    function render(items){
      if(items.length === 0){
        status.className = "empty";
        status.textContent = "No templates listed yet (templates/manifest.json).";
        status.style.display = "";
        container.style.display = "none";
        return;
      }
      status.style.display = "none";
      container.style.display = "";
      const { groups, order } = groupByLetter(items);
      container.innerHTML = "";
      for(const letter of order){
        const sec = document.createElement("section");
        sec.className = "group";
        const h2 = document.createElement("h2"); h2.textContent = letter;
        sec.appendChild(h2);
        groups[letter].sort((a,b)=> a.name.localeCompare(b.name)).forEach(s => sec.appendChild(makeItem(s)));
        container.appendChild(sec);
      }
      // Open hash anchor if provided
      if(location.hash){
        const el = document.getElementById(location.hash.slice(1));
        if(el && el.tagName.toLowerCase()==="details"){
          el.open = true;
          el.scrollIntoView({ behavior:"smooth", block:"start" });
        }
      }
    }

    async function load(){
      try{
        // Load manifest
        const manifestRaw = await fetchText(MANIFEST_URL);
        let list;
        try{
          const data = JSON.parse(manifestRaw);
          list = Array.isArray(data) ? data : (data.files || data.templates || []);
        }catch{
          throw new Error("Invalid JSON in templates/manifest.json");
        }
        if(!Array.isArray(list) || list.length === 0){ render([]); return; }

        // Load each template HTML, pull one element’s data + code
        const results = await Promise.all(list.map(async (filename)=>{
          const url = "templates/" + filename;
          const html = await fetchText(url);
          const doc = new DOMParser().parseFromString(html, "text/html");

          // Find a single element that contains everything
          let el = doc.querySelector('script.userscript, template.userscript, [data-userscript]');
          // If not found but file is just raw JS, fallback to treating whole text as code
          let dataset = {};
          let codeText = "";
          if(el){
            // Dataset (data-*) for easy editing
            dataset = { ...el.dataset }; // keys like name, description, version, etc.
            codeText = el.textContent || "";
          }else{
            codeText = html;
          }

          // Pull name/description (prefer data-attrs, fallback to meta block)
          const meta = parseUserscriptMeta(codeText);
          const name = dataset.name || meta.name || filename.replace(/\.html?$/i, "").replace(/[-_]+/g, " ");
          const description = dataset.description || meta.description || "";
          const slug = slugify(name);

          // Apply {{placeholders}} using data-* (plus name/description/filename/slug)
          const ctx = { ...dataset, name, description, filename, slug };
          const code = applyPlaceholders(codeText, ctx);

          return { filename, url, code, name, description, slug };
        }));

        render(results);
      }catch(err){
        status.className = "error";
        status.textContent = "Error: " + err.message;
      }
    }

    load();
  </script>
</body>
</html>
